<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="modskurt">
<title>Stan code for the discrete model â€¢ modskurt</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Stan code for the discrete model">
<meta property="og:description" content="modskurt">
<meta property="og:image" content="https://hdrab127.github.io/modskurt/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">modskurt</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../index.html" aria-label="msktr">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-vignettes">Vignettes</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-vignettes">
    <a class="dropdown-item" href="../articles/getting-started.html">How to use `modskurt`</a>
    <a class="dropdown-item" href="../articles/linked-zero-inflation.html">Linked zero-inflation (ZINBL)</a>
    <a class="dropdown-item" href="../articles/prior-specification.html">Prior specification</a>
    <a class="dropdown-item" href="../articles/discrete-stan.html">Stan discrete model</a>
    <a class="dropdown-item" href="../articles/examples.html">Examples</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Functions</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">News</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-other-packages">Other packages</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-other-packages">
    <a class="external-link dropdown-item" href="https://mc-stan.org/bayesplot/">bayesplot</a>
    <a class="external-link dropdown-item" href="http://paul-buerkner.github.io/brms/index.html">brms</a>
    <a class="external-link dropdown-item" href="https://mc-stan.org/cmdstanr">cmdstanr</a>
    <a class="external-link dropdown-item" href="https://mc-stan.org/loo">loo</a>
    <a class="external-link dropdown-item" href="https://mc-stan.org/posterior">posterior</a>
    <a class="external-link dropdown-item" href="https://mc-stan.org/projpred">projpred</a>
    <a class="external-link dropdown-item" href="https://mc-stan.org/rstan">rstan</a>
    <a class="external-link dropdown-item" href="https://mc-stan.org/rstanarm">rstanarm</a>
    <a class="external-link dropdown-item" href="https://mc-stan.org/rstantools">rstantools</a>
    <a class="external-link dropdown-item" href="https://mc-stan.org/shinystan">shinystan</a>
  </div>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://mc-stan.org">Stan</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/hdrab127/modskurt" aria-label="Github">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Stan code for the discrete model</h1>
            
      
      
      <div class="d-none name"><code>discrete-stan.Rmd</code></div>
    </div>

    
    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/stan.min.js"></script><script>hljs.highlightAll();</script><p>The following code in the Stan probabilistic programming language
defines a model where the discrete species abundance, <span class="math inline">\(y\)</span>, follows a zero-inflated negative
binomial distribution with probability of excess-zero and mean abundance
both linked to the data through <code>modskurt</code> mean functions of
the environmental gradient, <span class="math inline">\(x\)</span>.</p>
<pre><code class="language-stan"><code>functions {
  /*
  The "mskt" unimodal mean function
  @param xms ( predictor variable (real number vector) - mode (m, real number) ) 
              / scale (s, real number &gt; 0)
  @param H height of curve at mode (real number &gt; 0)
  @param r asymmetry (real number in (0, 1))
  @param d flatness (real number &gt;= 0)
  @param p tail exaggeration (real number in (0.05, 1.95))
  @return vector of mean values (real number vector &gt; 0)
  */
  vector mskt(vector xms, real H, real r, real d, real p) {
    real invp = 1 / p;
    real mdop = - d * invp;
    return fma(H,
               pow(fma(r, exp(fma(invp, xms / r, mdop)),
                       fma(1 - r, exp(fma(-invp, xms / (1 - r), mdop)),
                           - exp(mdop) + 1)),
                   -p),
               // avoid underflow for really small mu
               machine_precision());
    // unintuitively log scale creates more arithmetic precision issues
    // return log(H) - lmultiply(p, fma(
    //   r,
    //   exp( (xms ./ r - d) / p ),
    //   fma(
    //     1 - r,
    //     exp( -(xms ./ (1 - r) + d) / p ),
    //     - exp( -d / p ) + 1  
    //   )
    // ));
  }
  /*
  The "zinbl" zero-inflation link function
  @param mu mean negative binomial abundance (real number vector)
  @param H height of curve at mode (real number &gt; 0)
  @param g0 log-odds probability of excess zero when mu = 0
  @param g1 rate at which log-odds probability of excess zero decreases as mu increases
  @return vector of excess zero probabilities (real number vector in [0, 1])
  */
  vector zilink(vector mu, real H, real g0, real g1) {
    return inv_logit(fma(-g1 / H, mu, g0));
  }
  real std_halfnormal_rng() {
    real u = uniform_rng(0.5, 1);
    real y = inv_Phi(u);
    return y;
  }
}
data {
  int&lt;lower=1&gt; N;
  int&lt;lower=1&gt; Nz;
  vector[N] x;

  // effort (can be 1 if no offset required)
  vector[N] eff;

  // make predictions over grid
  int Nrep;
  vector[Nrep] xrep;

  // re-scaling
  real&lt;lower=0&gt; y_max;
  real&lt;lower=0&gt; x_pos_range;
  real x_pos_min;

  // hyperpriors
  vector[2] hp_H;
  vector[2] hp_m;
  vector[2] hp_s;
  vector[2] hp_r;
  vector[2] hp_d;
  vector[2] hp_p;

  // toggle optional vars H,m,s[,r,d,p,a]
  int&lt;lower=0,upper=1&gt; use_r;
  int&lt;lower=0,upper=1&gt; use_d;
  int&lt;lower=0,upper=1&gt; use_p;

  // specify fixed values for parameters if not being used^
  real&lt;lower=0,upper=1&gt;   fix_r;
  real&lt;lower=0&gt;           fix_d;
  real&lt;lower=0.1&gt;         fix_p;

  // 0: no prior, 1: with prior, 2: only prior
  int&lt;lower=0,upper=2&gt; sample_prior;
  // integer abundance y 
  array[N] int&lt;lower=0&gt; y;
  real&lt;lower=0&gt; hp_kap;

  int&lt;lower=0,upper=1&gt; use_zi;
  vector[2] hp_g0;
  vector[1] hp_g1;
}
transformed data {
  int Nzp = Nz + 1;
  real exp_hp_s1 = exp(hp_s[1]);
}
parameters {
  real&lt;lower=machine_precision(),upper=1&gt; zH;
  real&lt;lower=0,upper=1&gt;                   zm;
  real&lt;lower=machine_precision()&gt;         zs;
  array[use_r] real&lt;lower=machine_precision(),upper=1-machine_precision()&gt; zr;
  array[use_d] real                                                        zd;
  array[use_p] real&lt;lower=0,upper=1&gt;                                       zp;
  array[use_zi] real zg0;
  array[use_zi] real&lt;lower=0&gt; zg1;
  // hopefully that upper bound restricts phi &gt;= eps and avoids
  // underflow complaints MH tries kap -&gt; inf
  real&lt;lower=machine_precision(),upper=1/sqrt(machine_precision())&gt; kap;
}
transformed parameters {
  // extract z rv's and get on desired scale
  // fma =&gt; hp_sd * z + hp_mu
  // https://mc-stan.org/docs/stan-users-guide/reparameterizations.html
  real H = zH * y_max;
  real m = fma(x_pos_range, zm, x_pos_min);
  // this can sometimes reach zero...
  // a better solution might be to sample zs from half-normal
  // then use expm1? 
  // real s = exp(fma(hp_s[2], zs, hp_s[1])) * x_pos_range;
  real s = exp_hp_s1 * expm1(hp_s[2] * zs) * x_pos_range;
  real r;
  if (use_r &gt; 0) {
    r = zr[1];
  } else {
    r = fix_r;
  }
  real d;
  if (use_d &gt; 0) {
    d = exp(fma(hp_d[2], zd[1], hp_d[1]));
  } else {
    d = fix_d;
  }
  real p;
  if (use_p &gt; 0) {
    p = fma(1.95, zp[1], + 0.05);
  } else {
    p = fix_p;
  }
  vector[N] mu = eff .* mskt((x - m) / s, H, r, d, p);
  vector[N] lmu = log(mu);
  // for (n in 1:N) {
  //   if (is_nan(lmu[n])) {
  //     print("eff:", eff[n],
  //           ",x:", x[n],
  //           ",H:", H, 
  //           ",m:", m,
  //           ",s:", s, 
  //           ",r:", r, 
  //           ",d:", d, 
  //           ",p:", p);
  //   }
  // }
  // more numerically stable than pow(kap, -2)?
  real phi = 1 / square(kap);
  array[use_zi] real g0;
  array[use_zi] real g1;
  vector[N] zi;
  if (use_zi) {
    // logistic function of the relative mean
    g0[1] = fma(hp_g0[2], zg0[1], hp_g0[1]);
    g1[1] = hp_g1[1] * zg1[1];
    zi = inv_logit(fma(-g1[1] / H, mu, g0[1]));
  }
}
model {
  target += beta_lupdf(zH | hp_H[1], hp_H[2]);
  target += beta_lupdf(zm | hp_m[1], hp_m[2]);
  target += std_normal_lupdf(zs);
  if (use_r &gt; 0) {
    target += beta_lupdf(zr[1] | hp_r[1], hp_r[2]);
  }
  if (use_d &gt; 0) {
    target += std_normal_lupdf(zd[1]);
  }
  if (use_p &gt; 0) {
    target += beta_lupdf(zp[1] | hp_p[1], hp_p[2]);
  }
  target += exponential_lupdf(kap | hp_kap);
  if (use_zi) {
    target += std_normal_lupdf(g0[1]);
    target += std_normal_lupdf(g1[1]);
    if (Nz &gt; 0) {
      target += log_sum_exp(bernoulli_lupmf(1 | zi[1:Nz]),
                            bernoulli_lupmf(0 | zi[1:Nz]) +
                            neg_binomial_2_log_lupmf(0 | lmu[1:Nz], phi));
    }
    target += bernoulli_lupmf(0 | zi[Nzp:N]) +
              neg_binomial_2_log_lupmf(y[Nzp:N] | lmu[Nzp:N], phi);
  } else {
    target += neg_binomial_2_log_lupmf(y | lmu, phi);
  }
}
generated quantities {
  vector[N] log_lik;
  vector[Nrep] mu_rep;
  vector[Nrep] pr_mu_rep;
  real pr_H;
  real pr_m;
  real pr_s;
  real pr_r;
  real pr_d;
  real pr_p;
  real log_prior = 0;
  real pr_g0;
  real pr_g1;
  vector[Nrep] zi_rep;
  vector[Nrep] pr_zi_rep;
  array[N] int y_rep;
  array[N] int pr_y_rep;

  real pr_kap;
  real pr_phi;

  if (sample_prior &lt; 2) {
    mu_rep = mskt((xrep - m) / s, H, r, d, p);
    // calc log lik and yreps
    if (use_zi) {
      zi_rep = inv_logit(fma(-g1[1] / H, mu_rep, g0[1]));
      for (n in 1:N) {
        if (n &lt; Nzp) {
          log_lik[n] = log_sum_exp(bernoulli_lpmf(1 | zi[n]),
                                   bernoulli_lpmf(0 | zi[n]) +
                                   neg_binomial_2_log_lpmf(0 | lmu[n], phi));
        } else {
          log_lik[n] = bernoulli_lpmf(0 | zi[n]) +
                       neg_binomial_2_log_lpmf(y[n] | lmu[n], phi);
        }
        if (zi[n] &gt; machine_precision() &amp;&amp; bernoulli_rng(zi[n]) &gt; 0.5) {
          y_rep[n] = 0;
        } else {
          y_rep[n] = neg_binomial_2_log_rng(lmu[n], phi);
        }
      }
    } else {
      for (n in 1:N) {
        log_lik[n] = neg_binomial_2_log_lpmf(y[n] | lmu[n], phi);
        if (mu[n] == 0) {
          y_rep[n] = 0;
        } else {
          y_rep[n] = neg_binomial_2_rng(mu[n], phi);
        }
      }
    }
  }

  if (sample_prior &gt; 0) {
    // calcs log_prior for mean pars now
    // dont store these
    vector[N] pr_mu;

    // generate pars first for log_prior then transform
    real pr_zH = beta_rng(hp_H[1], hp_H[2]);
    log_prior += beta_lpdf(pr_zH | hp_H[1], hp_H[2]);
    pr_H = pr_zH * y_max;
    
    real pr_zm = beta_rng(hp_m[1], hp_m[2]);
    log_prior += beta_lpdf(pr_zm | hp_m[1], hp_m[2]);
    pr_m = fma(x_pos_range, pr_zm, x_pos_min);

    real pr_zs = std_normal_rng();
    log_prior += std_normal_lpdf(pr_zs);
    pr_s = exp(fma(hp_s[2], pr_zs, hp_s[1])) * x_pos_range;
    
    if (use_r &gt; 0) {
      pr_r = beta_rng(hp_r[1], hp_r[2]);
      log_prior += beta_lpdf(pr_r | hp_r[1], hp_r[2]);
    } else {
      pr_r = fix_r;
    }
    
    if (use_d &gt; 0) {
      real pr_zd = std_normal_rng();
      log_prior += std_normal_lpdf(pr_zd);
      pr_d = exp(fma(hp_d[2], pr_zd, hp_d[1]));
    } else {
      pr_d = fix_d;
    }
    
    if (use_p &gt; 0) {
      real pr_zp = beta_rng(hp_p[1], hp_p[2]);
      log_prior += beta_lpdf(pr_zp | hp_p[1], hp_p[2]);
      pr_p = fma(1.95, pr_zp, 0.05);
    } else {
      pr_p = fix_p;
    }
    
    // maybe we can just calc this and derive the evenly gridded versions after?
    pr_mu = eff .* mskt((x - pr_m) / pr_s, pr_H, pr_r, pr_d, pr_p);
    pr_mu_rep = mskt((xrep - pr_m) / pr_s, pr_H, pr_r, pr_d, pr_p);
    // calc zi &amp; yreps
    vector[N] pr_zi;
    if (use_zi) {
      pr_g0 = fma(hp_g0[2], std_normal_rng(), hp_g0[1]);
      pr_g1 = hp_g1[1] * std_halfnormal_rng();
      pr_zi = inv_logit(fma(-pr_g1 / pr_H, pr_mu, pr_g0));
      pr_zi_rep = inv_logit(fma(-pr_g1 / pr_H, pr_mu_rep, pr_g0));
    }
    pr_kap = exponential_rng(hp_kap);
    pr_phi = pow(pr_kap, -2);
    for (n in 1:N) {
      if (is_nan(pr_mu[n])) {
        pr_y_rep[n] = -999;
      } else if (pr_mu[n] &lt;= machine_precision() ||
          (!is_nan(pr_zi[n]) &amp;&amp;
           pr_zi[n] &gt; machine_precision() &amp;&amp;
           bernoulli_rng(pr_zi[n]) &gt; 0.5)) {
        pr_y_rep[n] = 0;
      } else {
        pr_y_rep[n] = neg_binomial_2_rng(pr_mu[n], pr_phi);
      }
    }
  }
}</code></code></pre>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Hayden Rabel, Adam Smith, Marti Anderson, the team at PRIMER-e.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
